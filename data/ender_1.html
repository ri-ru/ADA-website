<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>YouTube â€“ Xâ€“Y with Polar Breakdowns</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 12px 24px;
      background: transparent;
      color: #e5e7eb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      overflow-x: visible;
      overflow-y: auto;
    }
    h1 {
      margin: 0 0 6px;
      font-size: 22px;
      font-weight: 600;
    }
    p {
      margin: 0 0 12px;
      font-size: 13px;
      color: #9ca3af;
    }
    .note {
      margin-bottom: 12px;
      font-size: 12px;
      color: #6b7280;
    }
    .chart-container {
      position: relative;
      width: min(1400px, calc(100vw - 96px));
      height: clamp(350px, 40vh, 450px);
      background: transparent;
      margin: 10px 0 0;
      border-radius: 10px;
    }
    #xyChart {
      position: absolute;
      top: 0;
      left: 0;
      width: 100% !important;
      height: 100% !important;
    }
    #polarOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: auto;
    }
    @keyframes dropSlices {
      0% {
        transform: translateY(-60px) scale(0.85);
        opacity: 0;
      }
      60% {
        transform: translateY(10px) scale(1.03);
        opacity: 0.9;
      }
      100% {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }
    .polar-canvas {
      animation: dropSlices 0.7s ease forwards;
      opacity: 0;
    }
    .hover-tooltip {
      position: absolute;
      padding: 6px 10px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(56, 189, 248, 0.5);
      border-radius: 6px;
      font-size: 11px;
      color: #e0f2fe;
      pointer-events: none;
      white-space: nowrap;
      display: none;
      box-shadow: 0 10px 28px rgba(2, 6, 23, 0.6);
    }
    .category-legend {
      display: none; /* Hidden - selection done from parent Svelte component */
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      padding: 6px 0;
      width: min(1500px, calc(100vw - 32px));
      margin-left: 0;
      margin-right: 0;
    }
    .category-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.75);
      color: #e2e8f0;
      font-size: 11px;
      font-family: "Segoe UI", "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      letter-spacing: 0.2px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      outline: none;
      cursor: pointer;
      transition: transform 0.2s ease, background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
    }
    .category-pill:hover {
      transform: translateY(-1px);
      border-color: rgba(148, 163, 184, 0.8);
      background: rgba(21, 32, 58, 0.9);
    }
    .category-pill.active {
      color: #fdf4ff;
    }
    .category-pill .emoji {
      font-size: 13px;
    }
    .polar-anno {
      position: absolute;
      background: rgba(2,6,23,0.85);
      color: #e0f2fe;
      font-size: 10px;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid rgba(56,189,248,0.35);
      pointer-events: none;
      white-space: nowrap;
      transform: translate(-50%, -6px);
    }
    .polar-total {
      position: absolute;
      color: rgba(248, 250, 252, 0.72);
      font-weight: 600;
      text-shadow: 0 2px 8px rgba(2,6,23,0.8);
      pointer-events: none;
      transform: translate(-50%, -100%);
    }
    .url-section {
      display: none; /* Hidden - middle section */
      margin-top: 30px;
      width: min(1500px, calc(100vw - 32px));
    }
    .url-section h2 {
      margin: 0 0 6px;
      font-size: 18px;
      color: #f8fafc;
    }
    .url-multiples {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 14px;
    }
    .url-mini {
      background: rgba(2, 6, 23, 0.78);
      border: 1px solid rgba(56, 189, 248, 0.35);
      border-radius: 14px;
      padding: 16px 18px 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 240px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
      cursor: pointer;
    }
    .url-mini:hover {
      background: rgba(2, 6, 23, 0.9);
      border-color: rgba(56, 189, 248, 0.45);
      box-shadow: 0 8px 28px rgba(14, 165, 233, 0.16);
      transform: translateY(-2px);
    }
    .url-mini.active {
      border-color: rgba(56, 189, 248, 0.65);
      box-shadow: 0 6px 20px rgba(14, 165, 233, 0.25);
      min-height: 280px;
      transform: translateY(-1px) scale(1.005);
      background: radial-gradient(circle at 20% 20%, rgba(56,189,248,0.1), rgba(2,6,23,0.9));
    }
    .url-mini .mini-head {
      font-weight: 600;
      font-size: 12px;
      color: #cbd5f5;
      letter-spacing: 0.2px;
    }
    .url-mini .mini-summary {
      font-size: 10px;
      color: #9ca3af;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .url-mini .mini-summary .row {
      display: flex;
      justify-content: space-between;
    }
    .url-mini .mini-summary .label {
      font-weight: 600;
      color: #cbd5f5;
    }
    .url-mini canvas {
      width: 100% !important;
      height: 170px !important;
    }
    .stacked-wrap {
      display: none;
    }
    .focus-section {
      width: min(1400px, calc(100vw - 96px));
      margin-top: 16px;
      display: none;
    }
    .focus-card {
      background: rgba(2, 6, 23, 0.82);
      border: 1px solid rgba(56, 189, 248, 0.3);
      border-radius: 12px;
      padding: 12px 14px 10px;
    }
    .focus-head {
      font-weight: 700;
      color: #e2e8f0;
      margin-bottom: 6px;
      font-size: 13px;
    }
    .focus-card canvas {
      width: 100% !important;
      height: 200px !important;
    }
    .compare-section {
      width: min(1500px, calc(100vw - 32px));
      margin-top: 24px;
    }
    .compare-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 14px;
    }
    .compare-card {
      background: rgba(2, 6, 23, 0.82);
      border: 1px solid rgba(56, 189, 248, 0.25);
      border-radius: 16px;
      padding: 14px 16px 12px;
      min-height: 260px;
    }
    .compare-head {
      font-weight: 700;
      color: #e2e8f0;
      margin-bottom: 6px;
      font-size: 13px;
    }
    .compare-card canvas {
      width: 100% !important;
      height: 240px !important;
    }
    canvas {
      cursor: crosshair;
    }
  </style>
</head>
<body>
  <h1>From Indie to Industry: How YouTubeâ€™s Upload Volume Exploded (2008â€“2018)</h1>
  <p class="note">
    YouTube grew from 338k uploads in 2008 to over 15.2 million in 2018, and this rapid rise changed which categories became more or less common. Hover or click a category to see the exact share for each year.
  </p>

  <div class="chart-container">
    <canvas id="xyChart"></canvas>
    <div id="polarOverlay"></div>
  </div>
  <div class="category-legend" id="categoryLegend"></div>
  <div class="url-section">
    <h2>And creators kept adding links</h2>
    <p class="note">Each tile tracks the same years but focuses on videos containing at least one URL. Compare 2008 vs 2018 to see how link-heavy uploads surged by category.</p>
    <div class="url-multiples" id="urlMultiples"></div>
  </div>
  <div class="focus-section" id="focusSection">
    <h2>Focused category</h2>
    <p class="note">Click a category pill to see it with axes and ticks.</p>
    <div class="focus-card">
      <div class="focus-head" id="focusTitle"></div>
      <canvas id="focusChart"></canvas>
    </div>
  </div>
  <div class="compare-section" id="compareSection">
    <h2>Compare two categories</h2>
    <p class="note">Selected categories will appear below.</p>
    <div style="display:none;">
      <label style="color:#cbd5f5;font-size:12px;">Category A:
        <select id="compareSelectA" style="background:#0b1222;color:#e5e7eb;border:1px solid #334155;border-radius:8px;padding:6px 10px;">
          <option value="">Chooseâ€¦</option>
        </select>
      </label>
      <label style="color:#cbd5f5;font-size:12px;">Category B:
        <select id="compareSelectB" style="background:#0b1222;color:#e5e7eb;border:1px solid #334155;border-radius:8px;padding:6px 10px;">
          <option value="">Chooseâ€¦</option>
        </select>
      </label>
    </div>
    <div class="compare-grid">
      <div class="compare-card">
        <div class="compare-head" id="compareTitleA"></div>
        <canvas id="compareChartA"></canvas>
      </div>
      <div class="compare-card">
        <div class="compare-head" id="compareTitleB"></div>
        <canvas id="compareChartB"></canvas>
      </div>
    </div>
  </div>

  <script>
    // Helper: format big numbers as M (e.g. 1.2M)
    function formatMillions(value) {
      const v = Number(value) || 0;
      if (v >= 1_000_000) {
        return (v / 1_000_000).toFixed(v >= 10_000_000 ? 0 : 1) + "M";
      }
      if (v >= 1_000) {
        return (v / 1_000).toFixed(0) + "K";
      }
      return v.toString();
    }

    // --------------------------
    // 1) Data
    // --------------------------
    const dataRows = [
      {
        year: 2008,
        "Autos & Vehicles": 18476,
        "Comedy": 9555,
        "Education": 22799,
        "Entertainment": 55638,
        "Film & Animation": 7751,
        "Gaming": 25312,
        "Howto & Style": 26063,
        "Music": 51183,
        "News & Politics": 25270,
        "Nonprofits & Activism": 6123,
        "People & Blogs": 31167,
        "Pets & Animals": 6921,
        "Science & Technology": 17317,
        "Sports": 23328,
        "Travel & Events": 11130,
      },
      {
        year: 2009,
        "Autos & Vehicles": 35480,
        "Comedy": 14795,
        "Education": 41520,
        "Entertainment": 91212,
        "Film & Animation": 14809,
        "Gaming": 86693,
        "Howto & Style": 42771,
        "Music": 116200,
        "News & Politics": 67463,
        "Nonprofits & Activism": 13577,
        "People & Blogs": 60399,
        "Pets & Animals": 10295,
        "Science & Technology": 32539,
        "Sports": 45629,
        "Travel & Events": 21174,
      },
      {
        year: 2010,
        "Autos & Vehicles": 59593,
        "Comedy": 18945,
        "Education": 74632,
        "Entertainment": 153734,
        "Film & Animation": 28327,
        "Gaming": 141462,
        "Howto & Style": 67351,
        "Music": 174585,
        "News & Politics": 97464,
        "Nonprofits & Activism": 21495,
        "People & Blogs": 66036,
        "Pets & Animals": 15596,
        "Science & Technology": 52310,
        "Sports": 82347,
        "Travel & Events": 31476,
      },
      {
        year: 2011,
        "Autos & Vehicles": 88574,
        "Comedy": 32902,
        "Education": 120596,
        "Entertainment": 304094,
        "Film & Animation": 62429,
        "Gaming": 290048,
        "Howto & Style": 108199,
        "Music": 285111,
        "News & Politics": 169560,
        "Nonprofits & Activism": 28280,
        "People & Blogs": 97349,
        "Pets & Animals": 21037,
        "Science & Technology": 83395,
        "Sports": 137547,
        "Travel & Events": 45701,
      },
      {
        year: 2012,
        "Autos & Vehicles": 135684,
        "Comedy": 50393,
        "Education": 169777,
        "Entertainment": 497732,
        "Film & Animation": 91988,
        "Gaming": 509309,
        "Howto & Style": 180681,
        "Music": 404498,
        "News & Politics": 246839,
        "Nonprofits & Activism": 39107,
        "People & Blogs": 156526,
        "Pets & Animals": 30398,
        "Science & Technology": 125864,
        "Sports": 219892,
        "Travel & Events": 67591,
      },
      {
        year: 2013,
        "Autos & Vehicles": 162838,
        "Comedy": 68485,
        "Education": 216381,
        "Entertainment": 634714,
        "Film & Animation": 125449,
        "Gaming": 833420,
        "Howto & Style": 246132,
        "Music": 521508,
        "News & Politics": 349808,
        "Nonprofits & Activism": 59203,
        "People & Blogs": 221188,
        "Pets & Animals": 38922,
        "Science & Technology": 168943,
        "Sports": 287302,
        "Travel & Events": 83874,
      },
      {
        year: 2014,
        "Autos & Vehicles": 186404,
        "Comedy": 90952,
        "Education": 255626,
        "Entertainment": 807142,
        "Film & Animation": 170831,
        "Gaming": 1146869,
        "Howto & Style": 293392,
        "Music": 653974,
        "News & Politics": 460032,
        "Nonprofits & Activism": 70375,
        "People & Blogs": 411033,
        "Pets & Animals": 37009,
        "Science & Technology": 186324,
        "Sports": 330836,
        "Travel & Events": 78988,
      },
      {
        year: 2015,
        "Autos & Vehicles": 258044,
        "Comedy": 124527,
        "Education": 326137,
        "Entertainment": 1029927,
        "Film & Animation": 233288,
        "Gaming": 1512749,
        "Howto & Style": 380797,
        "Music": 795565,
        "News & Politics": 596981,
        "Nonprofits & Activism": 82187,
        "People & Blogs": 635832,
        "Pets & Animals": 48439,
        "Science & Technology": 220923,
        "Sports": 435426,
        "Travel & Events": 127107,
      },
      {
        year: 2016,
        "Autos & Vehicles": 260582,
        "Comedy": 164941,
        "Education": 446510,
        "Entertainment": 1565403,
        "Film & Animation": 329656,
        "Gaming": 2035816,
        "Howto & Style": 523933,
        "Music": 1012825,
        "News & Politics": 873908,
        "Nonprofits & Activism": 97483,
        "People & Blogs": 1012489,
        "Pets & Animals": 66900,
        "Science & Technology": 281005,
        "Sports": 545189,
        "Travel & Events": 135793,
      },
      {
        year: 2017,
        "Autos & Vehicles": 345724,
        "Comedy": 212665,
        "Education": 660003,
        "Entertainment": 2176261,
        "Film & Animation": 430470,
        "Gaming": 2478332,
        "Howto & Style": 702145,
        "Music": 1320471,
        "News & Politics": 1290183,
        "Nonprofits & Activism": 118501,
        "People & Blogs": 1411483,
        "Pets & Animals": 101161,
        "Science & Technology": 390603,
        "Sports": 687902,
        "Travel & Events": 160395,
      },
      {
        year: 2018,
        "Autos & Vehicles": 385196,
        "Comedy": 224823,
        "Education": 854858,
        "Entertainment": 2697068,
        "Film & Animation": 467608,
        "Gaming": 2641479,
        "Howto & Style": 791664,
        "Music": 1612171,
        "News & Politics": 2120989,
        "Nonprofits & Activism": 130403,
        "People & Blogs": 1684526,
        "Pets & Animals": 145417,
        "Science & Technology": 476513,
        "Sports": 861920,
        "Travel & Events": 181124,
      },
    ];

    const categories = [
      "Gaming",
      "Entertainment",
      "Music",
      "News & Politics",
      "People & Blogs",
      "Sports",
      "Howto & Style",
      "Education",
      "Science & Technology",
      "Film & Animation",
      "Autos & Vehicles",
      "Comedy",
      "Travel & Events",
      "Nonprofits & Activism",
      "Pets & Animals",
    ];

    const categoryEmojis = {
      "Autos & Vehicles": "ðŸš—",
      "Comedy": "ðŸ˜‚",
      "Education": "ðŸ“˜",
      "Entertainment": "ðŸŽ¬",
      "Film & Animation": "ðŸŽžï¸",
      "Gaming": "ðŸŽ®",
      "Howto & Style": "ðŸ§µ",
      "Music": "ðŸŽµ",
      "News & Politics": "ðŸ“°",
      "Nonprofits & Activism": "ðŸ¤",
      "People & Blogs": "ðŸ‘¥",
      "Pets & Animals": "ðŸ¾",
      "Science & Technology": "ðŸ”¬",
      "Sports": "ðŸ…",
      "Travel & Events": "âœˆï¸"
    };

    const years = dataRows.map(d => d.year);

    const totals = dataRows.map(row =>
      categories.reduce((sum, cat) => sum + (row[cat] || 0), 0)
    );

    // Palette for polar charts
    const palette = [
      "#0ea5e9", "#f97316", "#22c55e", "#eab308", "#a855f7",
      "#fb7185",
      "#f43f5e", "#14b8a6", "#6366f1", "#ec4899", "#84cc16",
      "#06b6d4", "#ef4444", "#8b5cf6", "#facc15"
    ];
    const categoryColors = categories.reduce((acc, cat, idx) => {
      acc[cat] = palette[idx % palette.length];
      return acc;
    }, {});
    const urlDataByYear = {
      2008: {"Travel & Events":3679,"Entertainment":22424,"People & Blogs":9987,"Nonprofits & Activism":3549,"Pets & Animals":2375,"Music":21963,"News & Politics":9089,"Autos & Vehicles":8447,"Howto & Style":15148,"Science & Technology":8952,"Comedy":4197,"Education":11776,"Sports":9146,"Gaming":9936,"Film & Animation":3524},
      2009: {"Travel & Events":8791,"Entertainment":42732,"People & Blogs":25590,"Nonprofits & Activism":6400,"Pets & Animals":4116,"Music":54013,"News & Politics":17526,"Autos & Vehicles":14722,"Howto & Style":26539,"Science & Technology":16708,"Comedy":7392,"Education":21423,"Sports":18331,"Gaming":31237,"Film & Animation":7610},
      2010: {"Travel & Events":12459,"Entertainment":73500,"People & Blogs":29844,"Nonprofits & Activism":10142,"Pets & Animals":6563,"Music":82066,"News & Politics":23374,"Autos & Vehicles":26618,"Howto & Style":46383,"Science & Technology":28250,"Comedy":9606,"Education":39246,"Sports":27332,"Gaming":58874,"Film & Animation":14453},
      2011: {"Travel & Events":20320,"Entertainment":152090,"People & Blogs":48277,"Nonprofits & Activism":12111,"Pets & Animals":9467,"Music":145114,"News & Politics":43092,"Autos & Vehicles":42843,"Howto & Style":73403,"Science & Technology":48183,"Comedy":17758,"Education":65052,"Sports":52083,"Gaming":161360,"Film & Animation":39037},
      2012: {"Travel & Events":30472,"Entertainment":298876,"People & Blogs":87387,"Nonprofits & Activism":19644,"Pets & Animals":15107,"Music":238955,"News & Politics":76775,"Autos & Vehicles":70526,"Howto & Style":135329,"Science & Technology":73057,"Comedy":26972,"Education":99364,"Sports":97834,"Gaming":335388,"Film & Animation":57822},
      2013: {"Travel & Events":41745,"Entertainment":401657,"People & Blogs":125562,"Nonprofits & Activism":31190,"Pets & Animals":20785,"Music":334743,"News & Politics":125974,"Autos & Vehicles":88078,"Howto & Style":196258,"Science & Technology":107370,"Comedy":39361,"Education":132849,"Sports":144904,"Gaming":633944,"Film & Animation":80630},
      2014: {"Travel & Events":40545,"Entertainment":539924,"People & Blogs":224993,"Nonprofits & Activism":28116,"Pets & Animals":22559,"Music":440914,"News & Politics":195563,"Autos & Vehicles":104330,"Howto & Style":240237,"Science & Technology":127258,"Comedy":56411,"Education":159912,"Sports":179731,"Gaming":941946,"Film & Animation":120377},
      2015: {"Travel & Events":77975,"Entertainment":717339,"People & Blogs":349662,"Nonprofits & Activism":51480,"Pets & Animals":29316,"Music":556422,"News & Politics":316352,"Autos & Vehicles":172977,"Howto & Style":317974,"Science & Technology":155944,"Comedy":74244,"Education":220831,"Sports":257952,"Gaming":1263173,"Film & Animation":158553},
      2016: {"Travel & Events":83326,"Entertainment":1181945,"People & Blogs":604201,"Nonprofits & Activism":67087,"Pets & Animals":41070,"Music":728162,"News & Politics":470327,"Autos & Vehicles":165476,"Howto & Style":436275,"Science & Technology":205839,"Comedy":98481,"Education":306033,"Sports":328519,"Gaming":1716077,"Film & Animation":220996},
      2017: {"Travel & Events":103854,"Entertainment":1622016,"People & Blogs":860586,"Nonprofits & Activism":75587,"Pets & Animals":70205,"Music":949318,"News & Politics":731850,"Autos & Vehicles":220875,"Howto & Style":590474,"Science & Technology":301642,"Comedy":126351,"Education":485948,"Sports":437542,"Gaming":2105389,"Film & Animation":287600},
      2018: {"Travel & Events":118943,"Entertainment":2022178,"People & Blogs":1005911,"Nonprofits & Activism":86276,"Pets & Animals":94581,"Music":1087263,"News & Politics":1258286,"Autos & Vehicles":263679,"Howto & Style":665634,"Science & Technology":368926,"Comedy":137355,"Education":663884,"Sports":574477,"Gaming":2283730,"Film & Animation":320182}
    };

    const xyCanvas = document.getElementById("xyChart");
    const overlay  = document.getElementById("polarOverlay");
    const legendEl = document.getElementById("categoryLegend");
    const urlMultiples = document.getElementById("urlMultiples");
    const xyCtx    = xyCanvas.getContext("2d");

    // --------------------------
    // URL Parameter & PostMessage Handling
    // --------------------------
    function getUrlParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    // Listen for messages from parent (Svelte)
    window.addEventListener("message", function(event) {
      if (event.data && event.data.type === "selectCategory") {
        const catName = event.data.category;
        if (catName && categories.includes(catName)) {
          setActiveCategory(catName);
        } else if (catName === null) {
          activeCategory = null;
          renderLegend();
          renderPolarOverlays();
          updateUrlMiniStyles();
        }
      }
      // Handle compare categories from Svelte
      if (event.data && event.data.type === "compareCategories") {
        const cats = event.data.categories || [];
        compareCats = cats.filter(c => categories.includes(c)).slice(0, 2);
        renderCompareCharts();
      }
    });

    // --------------------------
    // 2) Big Xâ€“Y Chart
    // --------------------------
    const xyChart = new Chart(xyCtx, {
      type: "line",
      data: {
        labels: years,
        datasets: [{
          label: "Total Videos",
          data: totals,
          borderColor: "rgba(0,0,0,0)",
          borderWidth: 0,
          backgroundColor: "rgba(0,0,0,0)",
          tension: 0.25,
          pointRadius: 0,
          pointHoverRadius: 0,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            title: { display: true, text: "Year", color: "#d1d5db" },
            ticks: { color: "#9ca3af" },
            grid: { color: "rgba(31,41,55,0.7)" },
          },
          y: {
            title: { display: true, text: "Total Videos (M)", color: "#d1d5db" },
            ticks: {
              color: "#9ca3af",
              callback: v => formatMillions(v),
            },
            grid: { color: "rgba(31,41,55,0.7)" },
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: true,
            mode: 'index',
            intersect: false,
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#e5e7eb',
            bodyColor: '#e5e7eb',
            borderColor: '#38bdf8',
            borderWidth: 1,
            padding: 12,
            displayColors: false,
            callbacks: {
              title: ctx => `Year ${ctx[0].label}`,
              label: ctx => {
                const raw = ctx.parsed.y;
                return `Total: ${formatMillions(raw)} videos`;
              }
            }
          }
        },
        animation: {
          duration: 700,
          onComplete: () => {
            renderPolarOverlays();
          }
        }
      }
    });

    let polarCharts = [];
    let hoverTooltip = null;
    let activeCategory = null;
    const urlMiniCharts = {};
    const urlMiniCards = {};
    let focusChart = null;
    const compareCharts = { a: null, b: null };
    let compareCats = [];
    function setActiveCategory(cat) {
      if (!cat) return;
      activeCategory = activeCategory === cat ? null : cat;
      compareCats = [];
      renderLegend();
      renderPolarOverlays();
      updateUrlMiniStyles();
    }

    function ensureHoverTooltip() {
      if (!hoverTooltip) {
        hoverTooltip = document.createElement("div");
        hoverTooltip.className = "hover-tooltip";
        overlay.appendChild(hoverTooltip);
      }
    }

    function showHoverTooltip(content, event) {
      ensureHoverTooltip();
      hoverTooltip.innerHTML = content;
      hoverTooltip.style.display = "block";
      const rect = overlay.getBoundingClientRect();
      const desiredLeft = event.clientX - rect.left + 12;
      const desiredTop = event.clientY - rect.top + 12;
      const maxLeft = overlay.clientWidth - hoverTooltip.offsetWidth - 4;
      const maxTop = overlay.clientHeight - hoverTooltip.offsetHeight - 4;
      hoverTooltip.style.left = `${Math.max(4, Math.min(desiredLeft, maxLeft))}px`;
      hoverTooltip.style.top = `${Math.max(4, Math.min(desiredTop, maxTop))}px`;
    }

    function hideHoverTooltip() {
      if (hoverTooltip) {
        hoverTooltip.style.display = "none";
      }
    }
    const urlTotalsByCategory = categories.reduce((acc, cat) => {
      acc[cat] = years.reduce((sum, year) => {
        const bucket = urlDataByYear[year] || {};
        return sum + (bucket[cat] || 0);
      }, 0);
      return acc;
    }, {});

    // Link specialty (monetization/content/social) per year/category
    const specialtyData = {"Travel & Events":{"2008":{"total":11130,"urls":3679,"monetization":621,"content":734,"social":657},"2009":{"total":21174,"urls":8791,"monetization":1858,"content":1922,"social":2590},"2010":{"total":31476,"urls":12459,"monetization":1807,"content":3164,"social":3153},"2011":{"total":45701,"urls":20320,"monetization":1603,"content":5507,"social":5489},"2012":{"total":67591,"urls":30472,"monetization":3744,"content":9825,"social":9616},"2013":{"total":83874,"urls":41745,"monetization":4109,"content":14106,"social":12568},"2014":{"total":78988,"urls":40545,"monetization":5129,"content":14467,"social":15654},"2015":{"total":127107,"urls":77975,"monetization":13851,"content":28912,"social":55383},"2016":{"total":135793,"urls":83326,"monetization":20520,"content":39132,"social":53636},"2017":{"total":160395,"urls":103854,"monetization":34037,"content":50801,"social":60041},"2018":{"total":181124,"urls":118943,"monetization":45458,"content":55525,"social":72761}},"Entertainment":{"2008":{"total":55638,"urls":22424,"monetization":973,"content":6518,"social":5389},"2009":{"total":91212,"urls":42732,"monetization":3325,"content":11593,"social":14451},"2010":{"total":153734,"urls":73500,"monetization":6768,"content":22448,"social":27729},"2011":{"total":304094,"urls":152090,"monetization":14215,"content":62836,"social":62690},"2012":{"total":497732,"urls":298876,"monetization":29251,"content":134354,"social":147516},"2013":{"total":634714,"urls":401657,"monetization":39451,"content":199915,"social":235311},"2014":{"total":807142,"urls":539924,"monetization":61319,"content":258024,"social":313265},"2015":{"total":1029927,"urls":717339,"monetization":99388,"content":374871,"social":453791},"2016":{"total":1565403,"urls":1181945,"monetization":229061,"content":632704,"social":806558},"2017":{"total":2176261,"urls":1622016,"monetization":328761,"content":943505,"social":1084249},"2018":{"total":2697068,"urls":2022178,"monetization":465051,"content":1141106,"social":1339619}},"People & Blogs":{"2008":{"total":31167,"urls":9987,"monetization":792,"content":2469,"social":2570},"2009":{"total":60399,"urls":25590,"monetization":2428,"content":5956,"social":6683},"2010":{"total":66036,"urls":29844,"monetization":2963,"content":9060,"social":9978},"2011":{"total":97349,"urls":48277,"monetization":6101,"content":16902,"social":21301},"2012":{"total":156526,"urls":87387,"monetization":12398,"content":32170,"social":40422},"2013":{"total":221188,"urls":125562,"monetization":20747,"content":55704,"social":65427},"2014":{"total":411033,"urls":224993,"monetization":40974,"content":108572,"social":129649},"2015":{"total":635832,"urls":349662,"monetization":69454,"content":175025,"social":213946},"2016":{"total":1012489,"urls":604201,"monetization":143194,"content":331928,"social":356116},"2017":{"total":1411483,"urls":860586,"monetization":237861,"content":480899,"social":502853},"2018":{"total":1684526,"urls":1005911,"monetization":338007,"content":546144,"social":594407}},"Nonprofits & Activism":{"2008":{"total":6123,"urls":3549,"monetization":230,"content":303,"social":227},"2009":{"total":13577,"urls":6400,"monetization":333,"content":772,"social":772},"2010":{"total":21495,"urls":10142,"monetization":596,"content":1218,"social":1606},"2011":{"total":28280,"urls":12111,"monetization":595,"content":1654,"social":2312},"2012":{"total":39107,"urls":19644,"monetization":1056,"content":3594,"social":4600},"2013":{"total":59203,"urls":31190,"monetization":1396,"content":11476,"social":10438},"2014":{"total":70375,"urls":28116,"monetization":1924,"content":7227,"social":8284},"2015":{"total":82187,"urls":51480,"monetization":3130,"content":24825,"social":10012},"2016":{"total":97483,"urls":67087,"monetization":4471,"content":29366,"social":22708},"2017":{"total":118501,"urls":75587,"monetization":6219,"content":35443,"social":24595},"2018":{"total":130403,"urls":86276,"monetization":8948,"content":42109,"social":33215}},"Pets & Animals":{"2008":{"total":6921,"urls":2375,"monetization":129,"content":492,"social":479},"2009":{"total":10295,"urls":4116,"monetization":456,"content":1115,"social":956},"2010":{"total":15596,"urls":6563,"monetization":819,"content":2118,"social":1741},"2011":{"total":21037,"urls":9467,"monetization":1222,"content":2591,"social":3087},"2012":{"total":30398,"urls":15107,"monetization":1862,"content":4350,"social":6505},"2013":{"total":38922,"urls":20785,"monetization":2396,"content":7308,"social":9582},"2014":{"total":37009,"urls":22559,"monetization":3181,"content":8864,"social":12783},"2015":{"total":48439,"urls":29316,"monetization":3097,"content":9609,"social":15870},"2016":{"total":66900,"urls":41070,"monetization":6419,"content":17588,"social":21328},"2017":{"total":101161,"urls":70205,"monetization":13252,"content":30737,"social":32805},"2018":{"total":145417,"urls":94581,"monetization":21825,"content":32366,"social":46709}},"Music":{"2008":{"total":51183,"urls":21963,"monetization":2848,"content":4829,"social":8260},"2009":{"total":116200,"urls":54013,"monetization":6876,"content":15191,"social":22882},"2010":{"total":174585,"urls":82066,"monetization":10684,"content":25114,"social":32455},"2011":{"total":285111,"urls":145114,"monetization":20313,"content":49744,"social":66260},"2012":{"total":404498,"urls":238955,"monetization":35688,"content":97071,"social":123960},"2013":{"total":521508,"urls":334743,"monetization":50618,"content":152632,"social":184106},"2014":{"total":653974,"urls":440914,"monetization":60822,"content":209126,"social":269238},"2015":{"total":795565,"urls":556422,"monetization":80966,"content":302127,"social":356773},"2016":{"total":1012825,"urls":728162,"monetization":112398,"content":416491,"social":470521},"2017":{"total":1320471,"urls":949318,"monetization":153929,"content":549530,"social":626568},"2018":{"total":1612171,"urls":1087263,"monetization":210006,"content":634416,"social":733537}},"News & Politics":{"2008":{"total":25270,"urls":9089,"monetization":167,"content":903,"social":667},"2009":{"total":67463,"urls":17526,"monetization":711,"content":1473,"social":3466},"2010":{"total":97464,"urls":23374,"monetization":1401,"content":3361,"social":5932},"2011":{"total":169560,"urls":43092,"monetization":1985,"content":6776,"social":13822},"2012":{"total":246839,"urls":76775,"monetization":3624,"content":14036,"social":26230},"2013":{"total":349808,"urls":125974,"monetization":15602,"content":34945,"social":45214},"2014":{"total":460032,"urls":195563,"monetization":21876,"content":69906,"social":101947},"2015":{"total":596981,"urls":316352,"monetization":29337,"content":111207,"social":185291},"2016":{"total":873908,"urls":470327,"monetization":45939,"content":172854,"social":302744},"2017":{"total":1290183,"urls":731850,"monetization":79393,"content":242818,"social":497074},"2018":{"total":2120989,"urls":1258286,"monetization":187238,"content":492943,"social":966315}},"Autos & Vehicles":{"2008":{"total":18476,"urls":8447,"monetization":326,"content":770,"social":1310},"2009":{"total":35480,"urls":14722,"monetization":1456,"content":3005,"social":2853},"2010":{"total":59593,"urls":26618,"monetization":1466,"content":3838,"social":4685},"2011":{"total":88574,"urls":42843,"monetization":3107,"content":9642,"social":11482},"2012":{"total":135684,"urls":70526,"monetization":5785,"content":18607,"social":25957},"2013":{"total":162838,"urls":88078,"monetization":7010,"content":33076,"social":37980},"2014":{"total":186404,"urls":104330,"monetization":12674,"content":40228,"social":48283},"2015":{"total":258044,"urls":172977,"monetization":17466,"content":53382,"social":113758},"2016":{"total":260582,"urls":165476,"monetization":29395,"content":74528,"social":92607},"2017":{"total":345724,"urls":220875,"monetization":46205,"content":97446,"social":118773},"2018":{"total":385196,"urls":263679,"monetization":66525,"content":106074,"social":132307}},"Howto & Style":{"2008":{"total":26063,"urls":15148,"monetization":1192,"content":3054,"social":2825},"2009":{"total":42771,"urls":26539,"monetization":2899,"content":6417,"social":7286},"2010":{"total":67351,"urls":46383,"monetization":6911,"content":14157,"social":14817},"2011":{"total":108199,"urls":73403,"monetization":11831,"content":26330,"social":33005},"2012":{"total":180681,"urls":135329,"monetization":25170,"content":56147,"social":68437},"2013":{"total":246132,"urls":196258,"monetization":34353,"content":95269,"social":110300},"2014":{"total":293392,"urls":240237,"monetization":51546,"content":120330,"social":146563},"2015":{"total":380797,"urls":317974,"monetization":73821,"content":166093,"social":194200},"2016":{"total":523933,"urls":436275,"monetization":119695,"content":239042,"social":270845},"2017":{"total":702145,"urls":590474,"monetization":189674,"content":329808,"social":367514},"2018":{"total":791664,"urls":665634,"monetization":240816,"content":369507,"social":416769}},"Science & Technology":{"2008":{"total":17317,"urls":8952,"monetization":774,"content":1453,"social":1330},"2009":{"total":32539,"urls":16708,"monetization":1885,"content":2685,"social":3900},"2010":{"total":52310,"urls":28250,"monetization":3528,"content":5480,"social":7276},"2011":{"total":83395,"urls":48183,"monetization":6761,"content":12542,"social":16811},"2012":{"total":125864,"urls":73057,"monetization":12008,"content":23394,"social":29900},"2013":{"total":168943,"urls":107370,"monetization":18188,"content":35496,"social":42846},"2014":{"total":186324,"urls":127258,"monetization":25478,"content":48734,"social":51924},"2015":{"total":220923,"urls":155944,"monetization":35986,"content":59654,"social":69847},"2016":{"total":281005,"urls":205839,"monetization":54695,"content":82989,"social":100559},"2017":{"total":390603,"urls":301642,"monetization":97122,"content":141437,"social":159717},"2018":{"total":476513,"urls":368926,"monetization":140457,"content":168463,"social":204010}},"Comedy":{"2008":{"total":9555,"urls":4197,"monetization":771,"content":2057,"social":1609},"2009":{"total":14795,"urls":7392,"monetization":969,"content":3328,"social":3539},"2010":{"total":18945,"urls":9606,"monetization":1257,"content":4776,"social":4771},"2011":{"total":32902,"urls":17758,"monetization":3069,"content":8669,"social":10281},"2012":{"total":50393,"urls":26972,"monetization":3982,"content":14674,"social":17169},"2013":{"total":68485,"urls":39361,"monetization":6033,"content":21824,"social":25434},"2014":{"total":90952,"urls":56411,"monetization":8992,"content":33100,"social":40380},"2015":{"total":124527,"urls":74244,"monetization":15018,"content":42847,"social":52705},"2016":{"total":164941,"urls":98481,"monetization":22944,"content":59151,"social":67271},"2017":{"total":212665,"urls":126351,"monetization":34762,"content":72288,"social":85802},"2018":{"total":224823,"urls":137355,"monetization":37463,"content":74066,"social":92899}},"Education":{"2008":{"total":22799,"urls":11776,"monetization":4506,"content":1915,"social":1099},"2009":{"total":41520,"urls":21423,"monetization":3381,"content":4303,"social":3133},"2010":{"total":74632,"urls":39246,"monetization":6758,"content":8740,"social":8314},"2011":{"total":120596,"urls":65052,"monetization":10774,"content":17958,"social":14205},"2012":{"total":169777,"urls":99364,"monetization":17329,"content":27955,"social":24201},"2013":{"total":216381,"urls":132849,"monetization":23495,"content":36946,"social":39917},"2014":{"total":255626,"urls":159912,"monetization":29144,"content":51207,"social":54783},"2015":{"total":326137,"urls":220831,"monetization":42443,"content":78743,"social":79237},"2016":{"total":446510,"urls":306033,"monetization":73108,"content":125944,"social":121672},"2017":{"total":660003,"urls":485948,"monetization":144457,"content":213262,"social":226670},"2018":{"total":854858,"urls":663884,"monetization":195638,"content":294786,"social":311816}},"Sports":{"2008":{"total":23328,"urls":9146,"monetization":1231,"content":870,"social":1305},"2009":{"total":45629,"urls":18331,"monetization":2117,"content":1941,"social":2278},"2010":{"total":82347,"urls":27332,"monetization":1974,"content":4744,"social":5887},"2011":{"total":137547,"urls":52083,"monetization":4815,"content":11114,"social":15726},"2012":{"total":219892,"urls":97834,"monetization":9906,"content":29333,"social":39561},"2013":{"total":287302,"urls":144904,"monetization":15844,"content":49040,"social":70902},"2014":{"total":330836,"urls":179731,"monetization":20721,"content":69086,"social":100367},"2015":{"total":435426,"urls":257952,"monetization":32972,"content":103323,"social":153635},"2016":{"total":545189,"urls":328519,"monetization":39258,"content":131206,"social":194982},"2017":{"total":687902,"urls":437542,"monetization":63799,"content":174015,"social":268311},"2018":{"total":861920,"urls":574477,"monetization":106342,"content":220995,"social":376588}},"Gaming":{"2008":{"total":25312,"urls":9936,"monetization":1466,"content":2982,"social":2466},"2009":{"total":86693,"urls":31237,"monetization":2401,"content":11360,"social":8414},"2010":{"total":141462,"urls":58874,"monetization":6331,"content":22413,"social":18266},"2011":{"total":290048,"urls":161360,"monetization":18377,"content":73850,"social":74861},"2012":{"total":509309,"urls":335388,"monetization":40046,"content":181513,"social":209638},"2013":{"total":833420,"urls":633944,"monetization":91530,"content":376999,"social":452301},"2014":{"total":1146869,"urls":941946,"monetization":203053,"content":577722,"social":708948},"2015":{"total":1512749,"urls":1263173,"monetization":378726,"content":787500,"social":951432},"2016":{"total":2035816,"urls":1716077,"monetization":603562,"content":1029184,"social":1299970},"2017":{"total":2478332,"urls":2105389,"monetization":802496,"content":1248837,"social":1578443},"2018":{"total":2641479,"urls":2283730,"monetization":906756,"content":1327323,"social":1705853}},"Film & Animation":{"2008":{"total":7751,"urls":3524,"monetization":377,"content":622,"social":590},"2009":{"total":14809,"urls":7610,"monetization":805,"content":1790,"social":2220},"2010":{"total":28327,"urls":14453,"monetization":1234,"content":4122,"social":5655},"2011":{"total":62429,"urls":39037,"monetization":10190,"content":14611,"social":22456},"2012":{"total":91988,"urls":57822,"monetization":6054,"content":21699,"social":27953},"2013":{"total":125449,"urls":80630,"monetization":7047,"content":31515,"social":39466},"2014":{"total":170831,"urls":120377,"monetization":12115,"content":52665,"social":57862},"2015":{"total":233288,"urls":158553,"monetization":21581,"content":77644,"social":84275},"2016":{"total":329656,"urls":220996,"monetization":38588,"content":114518,"social":118017},"2017":{"total":430470,"urls":287600,"monetization":56443,"content":159347,"social":151319},"2018":{"total":467608,"urls":320182,"monetization":71367,"content":175436,"social":164981}}};
    const linkTypes = ["monetization", "content", "social"];
    const linkColors = {
      monetization: "#22d3ee",
      content: "#a855f7",
      social: "#f97316",
    };

    function urlPercent(year, cat, absValue) {
      const row = dataRows.find(r => r.year === year);
      if (!row) return 0;
      const totalCat = row[cat] || 0;
      if (!totalCat) return 0;
      return (absValue / totalCat) * 100;
    }

    function createUrlMiniCharts() {
      if (!urlMultiples) return;
      urlMultiples.innerHTML = "";
      categories.forEach(cat => {
        const card = document.createElement("div");
        card.className = "url-mini";
        const firstYearVal = (urlDataByYear[years[0]] || {})[cat] || 0;
        const lastYearVal = (urlDataByYear[years[years.length - 1]] || {})[cat] || 0;
        const firstPct = urlPercent(years[0], cat, firstYearVal).toFixed(1);
        const lastPct = urlPercent(years[years.length - 1], cat, lastYearVal).toFixed(1);
        const firstRow = dataRows.find(r => r.year === years[0]);
        const lastRow = dataRows.find(r => r.year === years[years.length - 1]);
        const firstCatTotal = firstRow ? (firstRow[cat] || 0) : 0;
        const lastCatTotal = lastRow ? (lastRow[cat] || 0) : 0;
        card.innerHTML = `
          <div class="mini-head">${cat}</div>
          <div class="mini-summary">
            <div class="row"><span class="label">${years[0]}</span><span>${formatMillions(firstYearVal)} / ${formatMillions(firstCatTotal)} Â· ${firstPct}%</span></div>
            <div class="row"><span class="label">${years[years.length - 1]}</span><span>${formatMillions(lastYearVal)} / ${formatMillions(lastCatTotal)} Â· ${lastPct}%</span></div>
          </div>
          <canvas class="spark"></canvas>
        `;
        urlMultiples.appendChild(card);
        const canvas = card.querySelector("canvas.spark");
        const ctx = canvas.getContext("2d");
        const series = years.map(year => {
          const bucket = urlDataByYear[year] || {};
          return bucket[cat] || 0;
        });
        const catSpecial = specialtyData[cat] || {};
        const linkSeries = linkTypes.map(type => years.map(y => (catSpecial[y] || {})[type] || 0));
        const chart = new Chart(ctx, {
          type: "line",
          data: {
            labels: years,
            datasets: [
              {
                label: "URLs",
                data: series,
                cubicInterpolationMode: "monotone",
                tension: 0.35,
                borderWidth: 2,
                pointRadius: 0,
                pointHitRadius: 8,
                pointHoverRadius: 5,
                fill: true,
                backgroundColor: (categoryColors[cat] || "#38bdf8") + "22",
                borderColor: categoryColors[cat] || "#38bdf8",
              },
              ...linkTypes.map(type => ({
                label: type,
                data: linkSeries[linkTypes.indexOf(type)],
                tension: 0.35,
                borderWidth: 1.6,
                borderDash: [4, 3],
                pointRadius: 0,
                pointHitRadius: 8,
                pointHoverRadius: 4,
                fill: false,
                borderColor: linkColors[type] || "#94a3b8",
                hidden: true,
              }))
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: "index", intersect: false },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: "rgba(15,23,42,0.9)",
                borderColor: categoryColors[cat] || "#38bdf8",
                borderWidth: 1,
                padding: { top: 12, right: 12, bottom: 12, left: 12 },
                displayColors: false,
                bodySpacing: 8,
                cornerRadius: 12,
                caretSize: 4,
                caretPadding: 7,
                titleMarginBottom: 6,
                titleColor: "#e5e7eb",
                bodyColor: "#e5e7eb",
                titleFont: { size: 12, weight: "700", family: "Inter, system-ui, -apple-system, BlinkMacSystemFont, sans-serif" },
                bodyFont: { size: 11, weight: "400", family: "\"Segoe UI\", \"Inter\", system-ui, -apple-system, BlinkMacSystemFont, sans-serif" },
                itemSort: (a, b) => {
                  const aUrl = a.dataset.label === "URLs";
                  const bUrl = b.dataset.label === "URLs";
                  if (aUrl && !bUrl) return -1;
                  if (!aUrl && bUrl) return 1;
                  return (b.parsed.y || 0) - (a.parsed.y || 0);
                },
                callbacks: {
                  title: ctx => `Year ${ctx[0].label}`,
                  label: ctx => {
                    const year = Number(ctx.label);
                    const value = ctx.parsed.y || 0;
                    const pct = urlPercent(year, cat, value).toFixed(1);
                    const baseRow = dataRows.find(r => r.year === year);
                    const baseTotal = baseRow ? baseRow[cat] || 0 : 0;
                    if (ctx.dataset.label === "URLs") {
                      return `Urls Share: ${pct}% (${formatMillions(value)}/${formatMillions(baseTotal)})`;
                    }
                    const urlsVal = (urlDataByYear[year] || {})[cat] || 0;
                    const pctOfTotal = baseTotal ? ((value / baseTotal) * 100).toFixed(1) : "0.0";
                    const label = ctx.dataset.label;
                    return `${label.charAt(0).toUpperCase() + label.slice(1)}: ${pctOfTotal}% (${formatMillions(value)} urls)`;
                  }
                }
              }
            },
            scales: {
              x: { display: false },
              y: { display: false }
            }
          }
        });
        urlMiniCharts[cat] = chart;
        urlMiniCards[cat] = card;
      });
      updateUrlMiniStyles();
    }
    function updateUrlMiniStyles() {
      Object.entries(urlMiniCharts).forEach(([cat, chart]) => {
        const color = categoryColors[cat] || "#94a3b8";
        const dataset = chart.data.datasets[0];
        const card = urlMiniCards[cat];
        if (!activeCategory) {
          dataset.borderColor = color;
          dataset.backgroundColor = color + "1a";
          dataset.borderWidth = 2;
          card?.classList.remove("active");
          chart.data.datasets.slice(1).forEach(ds => ds.hidden = true);
          if (card) card.style.borderColor = "rgba(56, 189, 248, 0.35)";
        } else if (cat === activeCategory) {
          dataset.borderColor = color;
          dataset.backgroundColor = color + "55";
          dataset.borderWidth = 2.5;
          card?.classList.add("active");
          chart.data.datasets.slice(1).forEach(ds => ds.hidden = false);
          if (card) card.style.borderColor = color;
        } else {
          dataset.borderColor = color + "33";
          dataset.backgroundColor = "rgba(148,163,184,0.08)";
          dataset.borderWidth = 1;
          card?.classList.remove("active");
          chart.data.datasets.slice(1).forEach(ds => ds.hidden = true);
          if (card) card.style.borderColor = "rgba(148,163,184,0.25)";
        }
        chart.update("none");
      });
      renderFocusChart();
      renderCompareCharts();
    }

    function renderLegend() {
      if (!legendEl) return;
      legendEl.innerHTML = categories.map(cat => {
        const emoji = categoryEmojis[cat] || "â—‹";
        const active = activeCategory === cat ? " active" : "";
        const accent = categoryColors[cat] || "#c084fc";
        const activeStyle = active
          ? `style="background:${accent}1f;border-color:${accent};box-shadow:0 6px 22px ${accent}44;color:#fdf4ff;"`
          : "";
        return `<button type="button" class="category-pill${active}" data-category="${cat}" ${activeStyle}>
          <span class="emoji">${emoji}</span><span class="label">${cat}</span>
        </button>`;
      }).join("");
    }

    renderLegend();
    createUrlMiniCharts();
    if (urlMultiples) {
      urlMultiples.addEventListener("click", event => {
        const card = event.target.closest(".url-mini");
        if (!card) return;
        const head = card.querySelector(".mini-head");
        if (!head) return;
        const cat = head.textContent.trim();
        if (!cat) return;
        setActiveCategory(cat);
      });
    }
    if (legendEl) {
      legendEl.addEventListener("click", event => {
        const pill = event.target.closest(".category-pill");
        if (!pill) return;
        const cat = pill.dataset.category;
        setActiveCategory(cat);
      });
    }

    // populate compare selects
    (function initCompareSelects() {
      const selA = document.getElementById("compareSelectA");
      const selB = document.getElementById("compareSelectB");
      const buildOptions = sel => {
        if (!sel) return;
        sel.innerHTML = `<option value=\"\">Chooseâ€¦</option>` + categories.map(c => `<option value="${c}">${c}</option>`).join("");
      };
      buildOptions(selA);
      buildOptions(selB);
      const handleChange = () => {
        const a = selA?.value || "";
        const b = selB?.value || "";
        compareCats = [a, b].filter(Boolean).slice(0, 2);
        renderCompareCharts();
      };
      selA?.addEventListener("change", handleChange);
      selB?.addEventListener("change", handleChange);
      // initialize if both already chosen
      handleChange();
    })();

    function renderFocusChart() {
      const section = document.getElementById("focusSection");
      const titleEl = document.getElementById("focusTitle");
      const canvas = document.getElementById("focusChart");
      const cardEl = section?.querySelector(".focus-card");
      if (!section || !titleEl || !canvas) return;

      if (focusChart) {
        focusChart.destroy();
        focusChart = null;
      }

      if (!activeCategory) {
        section.style.display = "none";
        if (cardEl) cardEl.style.borderColor = "rgba(56, 189, 248, 0.3)";
        return;
      }

      section.style.display = "block";
      titleEl.textContent = activeCategory;
      if (cardEl) cardEl.style.borderColor = (categoryColors[activeCategory] || "#38bdf8");

      const ctx = canvas.getContext("2d");
      const series = years.map(year => (urlDataByYear[year] || {})[activeCategory] || 0);
      const catSpecial = specialtyData[activeCategory] || {};
      const linkSeries = linkTypes.map(type => years.map(y => (catSpecial[y] || {})[type] || 0));

      focusChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: years,
          datasets: [
            {
              label: "URLs",
              data: series,
              tension: 0.35,
              borderWidth: 2.5,
              pointRadius: 3,
              fill: false,
              borderColor: categoryColors[activeCategory] || "#38bdf8",
              backgroundColor: (categoryColors[activeCategory] || "#38bdf8") + "33",
            },
            ...linkTypes.map(type => ({
              label: type.charAt(0).toUpperCase() + type.slice(1),
              data: linkSeries[linkTypes.indexOf(type)],
              tension: 0.35,
              borderWidth: 1.8,
              pointRadius: 2.5,
              fill: false,
              borderDash: [4, 3],
              borderColor: linkColors[type] || "#94a3b8",
              backgroundColor: (linkColors[type] || "#94a3b8") + "33",
            }))
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          scales: {
            x: { ticks: { color: "#9ca3af" }, grid: { color: "rgba(31,41,55,0.35)" } },
            y: {
              ticks: { color: "#9ca3af", callback: v => formatMillions(v) },
              grid: { color: "rgba(31,41,55,0.35)" },
              beginAtZero: true
            }
          },
          plugins: {
            legend: { labels: { color: "#e5e7eb" } },
            tooltip: {
              backgroundColor: "rgba(15,23,42,0.9)",
              borderColor: categoryColors[activeCategory] || "#38bdf8",
              borderWidth: 1,
              displayColors: false,
              padding: { top: 12, right: 12, bottom: 12, left: 12 },
              bodySpacing: 7,
              cornerRadius: 10,
              caretSize: 4,
              caretPadding: 7,
              titleMarginBottom: 6,
              titleFont: { size: 12, weight: "700", family: "Inter, system-ui, -apple-system, BlinkMacSystemFont, sans-serif" },
              bodyFont: { size: 11, weight: "400", family: "\"Segoe UI\", \"Inter\", system-ui, -apple-system, BlinkMacSystemFont, sans-serif" },
              itemSort: (a, b) => {
                const aUrls = a.dataset.label === "URLs";
                const bUrls = b.dataset.label === "URLs";
                if (aUrls && !bUrls) return -1;
                if (!aUrls && bUrls) return 1;
                return (b.parsed.y || 0) - (a.parsed.y || 0);
              },
              callbacks: {
                title: ctx => `Year ${ctx[0].label}`,
                label: ctx => {
                  const year = Number(ctx.label);
                  const value = ctx.parsed.y || 0;
                  const total = (dataRows.find(r => r.year === year) || {})[activeCategory] || 0;
                  const urls = (urlDataByYear[year] || {})[activeCategory] || 0;
                  if (ctx.dataset.label === "URLs") {
                    const pct = total ? (value / total) * 100 : 0;
                    return `URLs: ${pct.toFixed(1)}% Â· ${formatMillions(value)} of ${formatMillions(total)}`;
                  }
                  const pctOfUrls = urls ? (value / urls) * 100 : 0;
                  return `${ctx.dataset.label}: ${pctOfUrls.toFixed(1)}% Â· ${formatMillions(value)} of URLs`;
                }
              }
            }
          }
        }
      });
    }

    function renderCompareCharts() {
      const section = document.getElementById("compareSection");
      const grid = document.querySelector(".compare-grid");
      const titleA = document.getElementById("compareTitleA");
      const titleB = document.getElementById("compareTitleB");
      const canvasA = document.getElementById("compareChartA");
      const canvasB = document.getElementById("compareChartB");
      const selA = document.getElementById("compareSelectA");
      const selB = document.getElementById("compareSelectB");
      const cardA = document.getElementById("compareChartA")?.closest(".compare-card");
      const cardB = document.getElementById("compareChartB")?.closest(".compare-card");
      if (!section || !titleA || !titleB || !canvasA || !canvasB) return;

      // destroy old charts
      if (compareCharts.a) { compareCharts.a.destroy(); compareCharts.a = null; }
      if (compareCharts.b) { compareCharts.b.destroy(); compareCharts.b = null; }

      if (compareCats.length < 2) {
        if (grid) grid.style.display = "none";
        if (cardA) cardA.style.borderColor = "rgba(56, 189, 248, 0.25)";
        if (cardB) cardB.style.borderColor = "rgba(56, 189, 248, 0.25)";
        return;
      }

      if (grid) grid.style.display = "grid";
      const [catA, catB] = compareCats;
      if (selA) selA.value = catA;
      if (selB) selB.value = catB;
      titleA.textContent = catA;
      titleB.textContent = catB;
      if (cardA) cardA.style.borderColor = categoryColors[catA] || "#38bdf8";
      if (cardB) cardB.style.borderColor = categoryColors[catB] || "#38bdf8";

      compareCharts.a = buildCompareChart(catA, canvasA.getContext("2d"));
      compareCharts.b = buildCompareChart(catB, canvasB.getContext("2d"));
    }

    function buildCompareChart(cat, ctx) {
      if (!ctx) return null;
      const series = years.map(year => (urlDataByYear[year] || {})[cat] || 0);
      const catSpecial = specialtyData[cat] || {};
      const linkSeries = linkTypes.map(type => years.map(y => (catSpecial[y] || {})[type] || 0));

      return new Chart(ctx, {
        type: "line",
        data: {
          labels: years,
          datasets: [
            {
              label: "URLs",
              data: series,
              tension: 0.35,
              borderWidth: 2.2,
              pointRadius: 2.5,
              fill: false,
              borderColor: categoryColors[cat] || "#38bdf8",
              backgroundColor: (categoryColors[cat] || "#38bdf8") + "33",
            },
            ...linkTypes.map(type => ({
              label: type.charAt(0).toUpperCase() + type.slice(1),
              data: linkSeries[linkTypes.indexOf(type)],
              tension: 0.35,
              borderWidth: 1.6,
              pointRadius: 2,
              fill: false,
              borderDash: [4, 3],
              borderColor: linkColors[type] || "#94a3b8",
              backgroundColor: (linkColors[type] || "#94a3b8") + "33",
            }))
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          scales: {
            x: { ticks: { color: "#9ca3af" }, grid: { color: "rgba(31,41,55,0.35)" } },
            y: {
              ticks: { color: "#9ca3af", callback: v => formatMillions(v) },
              grid: { color: "rgba(31,41,55,0.35)" },
              beginAtZero: true
            }
          },
          plugins: {
            legend: { labels: { color: "#e5e7eb" } },
            tooltip: {
              backgroundColor: "rgba(15,23,42,0.9)",
              borderColor: categoryColors[cat] || "#38bdf8",
              borderWidth: 1,
              displayColors: false,
              padding: { top: 12, right: 12, bottom: 12, left: 12 },
              bodySpacing: 7,
              cornerRadius: 10,
              caretSize: 4,
              caretPadding: 7,
              titleMarginBottom: 6,
              titleFont: { size: 12, weight: "700", family: "Inter, system-ui, -apple-system, BlinkMacSystemFont, sans-serif" },
              bodyFont: { size: 11, weight: "400", family: "\"Segoe UI\", \"Inter\", system-ui, -apple-system, BlinkMacSystemFont, sans-serif" },
              itemSort: (a, b) => {
                const aUrls = a.dataset.label === "URLs";
                const bUrls = b.dataset.label === "URLs";
                if (aUrls && !bUrls) return -1;
                if (!aUrls && bUrls) return 1;
                return (b.parsed.y || 0) - (a.parsed.y || 0);
              },
              callbacks: {
                title: ctx => `Year ${ctx[0].label}`,
                label: ctx => {
                  const year = Number(ctx.label);
                  const value = ctx.parsed.y || 0;
                  const total = (dataRows.find(r => r.year === year) || {})[cat] || 0;
                  const urls = (urlDataByYear[year] || {})[cat] || 0;
                  if (ctx.dataset.label === "URLs") {
                    const pct = total ? (value / total) * 100 : 0;
                    return `URLs: ${pct.toFixed(1)}% Â· ${formatMillions(value)} of ${formatMillions(total)}`;
                  }
                  const pctOfUrls = urls ? (value / urls) * 100 : 0;
                  return `${ctx.dataset.label}: ${pctOfUrls.toFixed(1)}% Â· ${formatMillions(value)} of URLs`;
                }
              }
            }
          }
        }
      });
    }

    // --------------------------
    // 3) Overlay Polar Charts
    // --------------------------
    function renderPolarOverlays() {
      // Clear previous overlays
      polarCharts.forEach(ch => ch.destroy && ch.destroy());
      polarCharts = [];
      overlay.innerHTML = "";
      hoverTooltip = null;
      ensureHoverTooltip();

      const meta = xyChart.getDatasetMeta(0);
      if (!meta || !meta.data) return;

      const maxTotal = Math.max(...totals);
      const sizeBase = 130;
      const sizeVar  = 80;

      years.forEach((year, index) => {
        const point = meta.data[index];
        if (!point) return;

        const cx = point.x;
        const cy = point.y;

        // Size scaled by total (sqrt so polar area follows total volume)
        const frac = totals[index] / maxTotal;
        const size = sizeBase + sizeVar * Math.sqrt(frac);

        const canvas = document.createElement("canvas");
        canvas.width  = size;
        canvas.height = size;
        canvas.style.position = "absolute";
        canvas.style.pointerEvents = "auto";
        canvas.style.left = `${cx - size / 2}px`;
        canvas.style.top  = `${cy - size / 2}px`;
        canvas.className = "polar-canvas";

        overlay.appendChild(canvas);

        const ctx = canvas.getContext("2d");
        const row = dataRows[index];

        const values   = categories.map(cat => row[cat]);
        const totalYear = values.reduce((s, v) => s + v, 0);
        const percents = values.map(v => (v / totalYear) * 100);
        const backgrounds = categories.map((cat, idx) => {
          if (!activeCategory) return palette[idx] + "aa";
          return cat === activeCategory ? palette[idx] + "ee" : palette[idx] + "10";
        });
        const borders = categories.map((cat, idx) => {
          if (!activeCategory) return palette[idx];
          return cat === activeCategory ? palette[idx] : palette[idx] + "33";
        });

        const polar = new Chart(ctx, {
          type: "polarArea",
          data: {
            labels: categories,
            datasets: [{
              data: percents,
              backgroundColor: backgrounds,
              borderColor: borders,
              borderWidth: activeCategory ? 1.4 : 1,
            }]
          },
          options: {
            responsive: false,
            maintainAspectRatio: false,
            scales: {
              r: {
                ticks: { display: false },
                grid: { display: false },
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                enabled: true,
                mode: 'single',
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: '#e5e7eb',
                bodyColor: '#e5e7eb',
                borderColor: '#38bdf8',
                borderWidth: 1,
                padding: 8,
                displayColors: false,
                callbacks: {
                  title: () => `Year ${year}`,
                  label: ctx => {
                    const label = ctx.label || "";
                    const pct   = Number(ctx.raw).toFixed(1) + "%";
                    const abs   = values[ctx.dataIndex] || 0;
                    return `${label}: ${pct} (${formatMillions(abs)} videos)`;
                  }
                }
              }
            }
          }
        });

        canvas.addEventListener("mousemove", evt => {
          const points = polar.getElementsAtEventForMode(evt, "nearest", { intersect: false }, false);
          if (points && points.length) {
            const idx = points[0].index;
            const label = categories[idx];
            if (activeCategory && label !== activeCategory) {
              hideHoverTooltip();
              return;
            }
            const pct = percents[idx].toFixed(1);
            const abs = values[idx];
            const content = `
              <strong>${year}</strong> Â· ${label}<br>
              ${pct}% (${formatMillions(abs)} videos)
            `.trim();
            showHoverTooltip(content, evt);
          } else {
            hideHoverTooltip();
          }
        });
        canvas.addEventListener("mouseleave", hideHoverTooltip);
        canvas.addEventListener("click", evt => {
          const points = polar.getElementsAtEventForMode(evt, "nearest", { intersect: false }, false);
          if (points && points.length) {
            const idx = points[0].index;
            const label = categories[idx];
            setActiveCategory(label);
          }
        });

        if (!activeCategory) {
          const totalLabel = document.createElement("div");
          totalLabel.className = "polar-total";
          totalLabel.textContent = formatMillions(totalYear);
          const fontSize = 12 + Math.sqrt(totalYear / maxTotal) * 8;
          totalLabel.style.fontSize = `${fontSize}px`;
          const constrainedLeft = Math.max(30, Math.min(cx, overlay.clientWidth - 30));
          const constrainedTop = Math.max(12, cy - size / 2 - 6);
          totalLabel.style.left = `${constrainedLeft}px`;
          totalLabel.style.top = `${constrainedTop}px`;
          overlay.appendChild(totalLabel);
        }

        polarCharts.push(polar);

        if (activeCategory) {
          const catIndex = categories.indexOf(activeCategory);
          if (catIndex >= 0) {
            const catValue = values[catIndex] || 0;
            const catPct = totalYear ? ((catValue / totalYear) * 100).toFixed(1) : "0.0";
            const anno = document.createElement("div");
            anno.className = "polar-anno";
            anno.innerHTML = `${activeCategory}<br>${formatMillions(catValue)} (${catPct}%)`;
            const annoLeft = Math.max(0, Math.min(cx, overlay.clientWidth));
            const annoTop = Math.max(4, cy - size / 2 - 14);
            anno.style.left = `${annoLeft}px`;
            anno.style.top = `${annoTop}px`;
            overlay.appendChild(anno);
          }
        }
      });
    }

    // Recompute positions on window resize
    window.addEventListener("resize", () => {
      setTimeout(() => {
        renderPolarOverlays();
      }, 150);
    });

    // Check URL param on load and set initial category
    const initialCategory = getUrlParam("category");
    if (initialCategory && categories.includes(initialCategory)) {
      setTimeout(() => {
        setActiveCategory(initialCategory);
      }, 800); // Wait for chart to render first
    }

    // Handle view mode - hide/show sections based on URL param
    const viewMode = getUrlParam("view") || "all";
    
    // Elements to control
    const mainChartContainer = document.querySelector('.chart-container');
    const mainTitle = document.querySelector('h1');
    const mainNote = document.querySelector('body > p.note');
    const categoryLegend = document.getElementById('categoryLegend');
    const urlSection = document.querySelector('.url-section');
    const focusSection = document.getElementById('focusSection');
    const compareSection = document.getElementById('compareSection');

    if (viewMode === "main") {
      // Show main chart and focus section (for when category is selected)
      if (urlSection) urlSection.style.display = 'none';
      // focusSection stays visible - will show when category selected
      if (compareSection) compareSection.style.display = 'none';
    } else if (viewMode === "compare") {
      // Show only the comparison section
      if (mainChartContainer) mainChartContainer.style.display = 'none';
      if (mainTitle) mainTitle.style.display = 'none';
      if (mainNote) mainNote.style.display = 'none';
      if (categoryLegend) categoryLegend.style.display = 'none';
      if (urlSection) urlSection.style.display = 'none';
      if (focusSection) focusSection.style.display = 'none';
      // compareSection stays visible
    }
  </script>
</body>
</html>